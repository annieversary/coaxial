<script>
    class Coaxial {
        constructor() {
            this.conn = new WebSocket(window.location);
            this.conn.onopen = () => {
                console.log('Connected.');
                /* this.send({t: 'init'}); */
            };
            this.conn.onmessage = async (e) => {
                const msg = JSON.parse(e.data);

                if (msg.t === 'Update') {
                    for (const [field, value] of msg.fields) {
                        document.querySelectorAll(`[data-coaxial-id="${field}"]`).forEach(el => {
                            el.innerHTML = value;
                        });
                    }
                }
            };
        }

        callClosure(closure) {
            this.send({ t: 'Closure', closure });
        }

        onEvent(name, params) {
            this.send({ t: 'Event', name, params });
        }

        send(body) {
            this.conn.send(JSON.stringify(body));
        }
    }

    document.addEventListener("DOMContentLoaded", event => {
        window.Coaxial = new Coaxial();
    });

    // https://stackoverflow.com/a/34519193
    function stringifyEvent(e) {
        const obj = {};
        for (let k in e) {
            obj[k] = e[k];
        }
        return JSON.stringify(obj, (k, v) => {
            if (v instanceof Node) return 'Node';
            if (v instanceof Window) return 'Window';
            return v;
        }, ' ');
    }
</script>
