<script>
    class Coaxial {
        constructor() {
            this.conn = new WebSocket(window.location);
            this.conn.onopen = () => {
                console.log('Connected.');
                /* this.send({t: 'init'}); */
            };
            this.conn.onmessage = async (e) => {
                const msg = JSON.parse(e.data);

                if (msg.t === 'Update') {
                    for (const [field, value] of msg.fields) {
                        document.querySelectorAll(`[data-coaxial-id="${field}"]`).forEach(el => {
                            el.innerHTML = value;
                        });
                    }
                }
            };
        }

        callClosure(closure) {
            this.send({ t: 'Closure', closure });
        }

        onEvent(name, params) {
            // TODO why the fuck are the params not working correctly if i dont do this
            params = { clientX: params.clientX, clientY: params.clientY };
            this.send({ t: 'Event', name, params });
        }

        send(body) {
            this.conn.send(JSON.stringify(body));
        }
    }

    document.addEventListener("DOMContentLoaded", event => {
        window.Coaxial = new Coaxial();
    });

</script>
