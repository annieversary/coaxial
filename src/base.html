<script>
    class Coaxial {
        constructor() {
            this.conn = new WebSocket(window.location);
            this.conn.onopen = () => {
                console.log('Connected.');
                /* this.send({t: 'init'}); */
            };
            this.conn.onmessage = async (e) => {
                // TODO repalce whatever has changed
                const msg = JSON.parse(e.data);
                console.log(msg);

                if (msg.t === 'Update') {
                    for (const [field, value] of msg.fields) {
                        document.querySelectorAll(`[data-coaxial-id="${field}"]`).forEach(el => {
                            el.innerHTML = value;
                        });
                    }
                }
            };
        }

        callClosure(closure) {
            this.send({ t: 'Closure', closure });
        }

        send(body) {
            this.conn.send(JSON.stringify(body));
        }
    }

    document.addEventListener("DOMContentLoaded", (event) => {
        window.Coaxial = new Coaxial();
    });
</script>
